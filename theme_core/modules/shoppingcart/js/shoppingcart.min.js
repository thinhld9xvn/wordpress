var jshoppingcart={};jshoppingcart.data=[],jshoppingcart.bindMethod=function(){var t=this.data;t.getTotal=function(){var t=0,a=this;if(a.length>0)for(var n=0;n<a.length;n++)t+=a[n].getTotal();return t};for(var a=0;a<t.length;a++)t[a].getTotal=function(){return parseInt(this.price)*parseInt(this.quantity)}},jQuery(function(t){var a=[],n={language:{decimal:",",thousands:".",lengthMenu:"Hiển thị _MENU_ kết quả",zeroRecords:"Chưa có sản phẩm nào trong giỏ hàng.",info:"Trang _PAGE_ / _PAGES_",infoEmpty:"Không có sản phẩm nào",infoFiltered:"",search:"Tìm sản phẩm ",paginate:{first:"Trang đầu",previous:"Trước",next:"Sau",last:"Trang cuối"}},pageLength:25},e={updateSCartRTime:{updateNumSTCart:function(){t(".jshoppingcart").find(".numcart").text(jshoppingcart.data.length)},updateRowsSTCart:function(a){var n=e.updateSCartRTime,r=t(".jshoppingcart").find("table");r.find("tbody").find("tr:not(.empty)").remove(),a.length>0?(n.setSCartNotEmpty(),t.each(a,function(t,a){var n='<tr class="p'+a.id+'">   <td class="name">'+a.name+'</td>   <td class="quantity">'+a.quantity+"</td></tr>";r.find("tbody").append(n)})):n.setSCartEmpty(),n.updateNumSTCart(),n.updateSubTotalCarts()},setSCartNotEmpty:function(){var a=t(".jshoppingcart").find("table");a.hasClass("-hasCart")||a.addClass("-hasCart")},setSCartEmpty:function(){var a=t(".jshoppingcart").find("table");a.hasClass("-hasCart")&&a.removeClass("-hasCart")},updateSubTotalCarts:function(){var a=t(".totalPriceCarts"),n=0;a.length>0&&(jshoppingcart.data.length>0&&(n=currency.formatMoney(jshoppingcart.data.getTotal(),0,".",",")),a.text(n))},updateOrderCartsFormContent:function(){setInterval(function(){var a=jshoppingcart.data,n=a.length;if(n>0){for(var e=t("input[type=hidden][name=txtNoiDungDatHang]"),r="",o=0;o<n;o++)r+="\t- Sản phẩm "+(o+1)+":\r\n",r+="\t\t+ Tên sản phẩm: "+a[o].name+"\r\n\t\t+ Mã sản phẩm: "+a[o].opcode+"\r\n\t\t+ Số lượng: "+a[o].quantity+"\r\n\t\t+ Đơn giá: "+currency.formatMoney(a[o].price,0,".",",")+" VNĐ\r\n\t\t+ Thành tiền: "+currency.formatMoney(a[o].getTotal(),0,".",",")+" VNĐ\r\n";r+="\t- Tổng tiền phải thanh toán: "+currency.formatMoney(a.getTotal(),0,".",",")+" VNĐ\r\n",e.val(r)}},200)}},updateScToServer:function(a){var n={action:"sb_shoppingcart_ajax",cmd:"update_carts",carts:JSON.stringify(jshoppingcart.data)};e.updateSCartRTime.updateRowsSTCart(jshoppingcart.data),t.ajax({type:"POST",async:!0,cache:!1,url:sb_admin_ajax.url,data:n}).done(function(){t.modal.close(),t.isFunction(a)&&a()})},getScFromServer:function(){var a={action:"sb_shoppingcart_ajax",cmd:"get_carts"};return t.ajax({type:"POST",async:!0,cache:!1,url:sb_admin_ajax.url,data:a})},determineRowHasQty:function(t){for(var a=t,n=null,e=!1;!e;)if(n=a.find(".quantity"),n.length>0)e=!0;else{if(!a.hasClass("child"))return!1;a=a.prev()}return a},addToCartEvent:function(a){a.preventDefault(),t("#orderScModal").modal({escapeClose:!1,clickClose:!1,showClose:!1});var n={id:parseInt(t(this).attr("data-pid")),name:t(this).attr("data-pname"),price:parseFloat(t(this).attr("data-pprice")),opcode:t(this).attr("data-popcode"),quantity:void 0!==t(this).attr("data-pqty")&&""!==t(this).attr("data-pqty")?parseInt(t(this).attr("data-pqty")):parseInt(t("#txtQty").val())},r=function(){t("#addToCartSuccessModal").modal({escapeClose:!1,clickClose:!1,showClose:!1})};e.getScFromServer().then(function(t){jshoppingcart.data=t,jshoppingcart.data.length>0&&jshoppingcart.bindMethod();var a=jshoppingcart.data.filter(function(t){return t.id===n.id});if(a.length>0){var o=a[0],i=jshoppingcart.data.findIndex(function(t){return t.id===o.id});i!==-1&&(jshoppingcart.data[i].quantity+=n.quantity)}else jshoppingcart.data.push(n);e.updateScToServer(r)})},updateCart:function(n){var r=t(this).closest("tr"),o=0,i=null,s="",p=function(n,r){t("#orderScModal").modal({escapeClose:!1,clickClose:!1,showClose:!1}),e.getScFromServer().then(function(t){jshoppingcart.data=t,jshoppingcart.data.length>0&&jshoppingcart.bindMethod(),jshoppingcart.data[n].quantity=r,a[0].cell(n,4).data(currency.formatMoney(jshoppingcart.data[n].getTotal(),0,".",",")).draw(),e.updateScToServer()})};switch(r=e.determineRowHasQty(r),o=r.index('tbody tr[role="row"]'),n.type){case"keyup":13===n.which&&(s=t(this).val(),""!==s&&parseInt(s)>0?p(o,s):(alert("Mời nhập số lượng sản phẩm !"),t(this).val(jshoppingcart.data[index].quantity)),t(this).blur());break;default:i=r.find(".quantity"),s=i.val(),""!==s&&parseInt(s)>0?p(o,s):(alert("Mời nhập số lượng sản phẩm !"),i.val(jshoppingcart.data[o].quantity))}},removeCart:function(n){t("#orderScModal").modal({escapeClose:!1,clickClose:!1,showClose:!1});var r=t(this).closest("tr"),o=0,i=t(this).closest("table").index(".dataTable");e.getScFromServer().then(function(n){jshoppingcart.data=n,jshoppingcart.data.length>0&&jshoppingcart.bindMethod(),r=e.determineRowHasQty(r),o=r.index('tbody tr[role="row"]'),a[i].row(o).remove().draw(),jshoppingcart.data.splice(o,1),e.updateScToServer(),0===jshoppingcart.data.length&&t(".shoppingcart-customdisplay").addClass("hidden")})}};t(document).on("click",".addToScButton",e.addToCartEvent).on("keyup",".dataTable.listCarts .quantity",e.updateCart).on("click",".dataTable .btnUpdateCart",e.updateCart).on("click",".dataTable .btnRemoveCart",e.removeCart);var r=t('*[data-navig="jmyscart"]');r.length>0&&r.each(function(r,o){jshoppingcart.data.length>0&&(a[r]=t(this).DataTable(n),e.updateSCartRTime.updateOrderCartsFormContent())})});