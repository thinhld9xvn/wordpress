<?php

	global $grunts;

	$grunts = array(

		'js' => array(

			'https://code.jquery.com/jquery-1.12.4.min.js',

			ABSPATH . '/wp-content/themes/consulting/assets/js/bootstrap.min.js?ver=4.6.8.1',

			ABSPATH . '/wp-content/plugins/digiproveblog/copyright_proof_live.js?ver=4.06',
			ABSPATH . '/wp-content/plugins/digiproveblog/frustrate_copy.js?ver=4.06',

			ABSPATH . '/wp-content/plugins/revslider/public/assets/js/revolution.tools.min.js?ver=6.0',
			ABSPATH . '/wp-content/plugins/revslider/public/assets/js/rs6.min.js?ver=6.1.3',

			ABSPATH . '/wp-content/themes/consulting/inc/megamenu/assets/js/megamenu.js?ver=5.3.2',					

			ABSPATH . '/wp-content/plugins/stm-gdpr-compliance/assets/js/scripts.js?ver=5.3.2',
			ABSPATH . '/wp-content/plugins/seo-by-rank-math/assets/front/js/rank-math.js?ver=1.0.37.1',
			ABSPATH . '/wp-content/themes/consulting/assets/js/select2.min.js?ver=4.6.8.1',
			ABSPATH . '/wp-content/themes/consulting/assets/js/custom.js?ver=4.6.8.1',
			ABSPATH . '/wp-content/plugins/wp-schema-pro/admin/assets/js/frontend.js?ver=1.3.0',
			ABSPATH . '/wp-content/plugins/js_composer/assets/js/dist/js_composer_front.min.js?ver=6.0.5',
			ABSPATH . '/wp-content/plugins/js_composer/assets/lib/vc_waypoints/vc-waypoints.min.js?ver=6.0.5',
			ABSPATH . '/wp-content/plugins/js_composer/assets/lib/vc_accordion/vc-accordion.min.js?ver=6.0.5',
			ABSPATH . '/wp-content/plugins/js_composer/assets/lib/vc-tta-autoplay/vc-tta-autoplay.min.js?ver=6.0.5',

			ABSPATH . '/wp-content/themes/consulting/assets/js/slick.min.js?ver=4.6.8.1',
			ABSPATH . '/wp-content/plugins/js_composer/assets/lib/prettyphoto/js/jquery.prettyPhoto.min.js?ver=6.0.5',
			ABSPATH . '/wp-content/plugins/js_composer/assets/lib/owl-carousel2-dist/owl.carousel.min.js?ver=6.0.5',
			ABSPATH . '/wp-content/plugins/js_composer/assets/lib/bower/imagesloaded/imagesloaded.pkgd.min.js?ver=6.0.5',
			ABSPATH . '/wp-includes/js/underscore.min.js?ver=1.8.3',
			ABSPATH . '/wp-content/plugins/js_composer/assets/js/dist/vc_grid.min.js?ver=6.0.5',

			ABSPATH . '/wp-content/themes/consulting/assets/js/jquery.lazy-loading.js',

			//'https://popupmaker.com/assets/lib/SGPMPopup.min.js',

			//'https://forms.toomarketer.com/scripts/toomarketer-web-form-core.js?rf=1579310411883',
			//'https://forms.toomarketer.com/Content/Site-nonejs.css?1579310411883',
			//'https://forms.toomarketer.com/Scripts/moment.js?rf=1579310412472',
			//'https://forms.toomarketer.com/Scripts/pikaday.js',
			//'https://forms.toomarketer.com/Scripts/URI.js',					

			//'https://www.googleadservices.com/pagead/conversion_async.js',
			//'https://www.google-analytics.com/analytics.js',

			//'https://connect.facebook.net/en_US/fbevents.js',
			//'https://connect.facebook.net/signals/config/1495377717204532?v=2.9.15&r=stable',

			//'http://live.vnpgroup.net/client/tracking.js?id=10214034',

			//'http://static.getclicky.com/js',

			//'https://www.googletagmanager.com/gtag/js?id=UA-151023257-5',
			//'https://www.googletagmanager.com/gtag/js?id=AW-712860541',

			//'https://googleads.g.doubleclick.net/pagead/viewthroughconversion/712860541/?random=1579310408566&cv=9&fst=1579310408566&num=1&bg=ffffff&guid=ON&resp=GooglemKTybQhCsO&u_h=768&u_w=1366&u_ah=728&u_aw=1366&u_cd=24&u_his=4&u_tz=420&u_java=false&u_nplug=3&u_nmime=4&gtm=2ou181&sendb=1&ig=1&data=event%3Dgtag.config&frm=0&url=https%3A%2F%2Fgig.com.vn%2F&tiba=C%C3%B4ng%20Ty%20T%C6%B0%20V%E1%BA%A5n%20%C4%90%E1%BA%A7u%20T%C6%B0%20v%C3%A0%20%C4%90%E1%BB%8Bnh%20C%C6%B0%20Qu%E1%BB%91c%20T%E1%BA%BF%20GIG%20Vi%E1%BB%87t%20Nam%20-%20GIG&hn=www.googleadservices.com&async=1&rfmt=3&fmt=4',

			//'https://in.getclicky.com/in.php?site_id=101222208&type=pageview&href=%2F&title=C%C3%B4ng%20Ty%20T%C6%B0%20V%E1%BA%A5n%20%C4%90%E1%BA%A7u%20T%C6%B0%20v%C3%A0%20%C4%90%E1%BB%8Bnh%20C%C6%B0%20Qu%E1%BB%91c%20T%E1%BA%BF%20GIG%20Vi%E1%BB%87t%20Nam%20-%20GIG&res=1366x768&lang=en&jsuid=2314148323&upset&mime=js&x=0.719369963702069'		

		),

		'css' => array(
			//'https://fonts.googleapis.com/css?family=Roboto&display=swap',

			ABSPATH . '/wp-includes/css/dist/block-library/style.min.css?ver=5.3.2',			
			ABSPATH . '/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=5.1.5',
			ABSPATH . '/wp-content/uploads/stm_fonts/stm/stm.css?ver=1.0',
			ABSPATH . '/wp-content/plugins/revslider/public/assets/css/rs6.css?ver=6.1.3',
			ABSPATH . '/wp-content/plugins/stm-gdpr-compliance/assets/css/styles.css?ver=5.3.2',
			ABSPATH . '/wp-content/plugins/seo-by-rank-math/assets/front/css/rank-math.css?ver=1.0.37.1',
			ABSPATH . '/wp-content/themes/consulting/assets/css/bootstrap.min.css?ver=4.6.8.1',
			ABSPATH . '/wp-content/themes/consulting/assets/css/font-awesome.min.css?ver=4.6.8.1',
			ABSPATH . '/wp-content/themes/consulting/style.css?ver=4.6.8.1',
			ABSPATH . '/wp-content/themes/consulting/assets/css/layout_1/main.css?ver=4.6.8.1',
			ABSPATH . '/wp-content/themes/consulting/assets/css/select2.min.css?ver=4.6.8.1',
			ABSPATH . '/wp-content/themes/consulting/assets/css/header_builder.css?ver=4.6.8.1',
			ABSPATH . '/wp-content/themes/consulting/assets/css/layout_1/skin-turquoise.css?ver=4.6.8.1',
			ABSPATH . '/wp-content/themes/consulting/inc/megamenu/assets/css/megamenu.css?ver=5.3.2',
			ABSPATH . '/wp-content/plugins/js_composer/assets/css/js_composer.min.css?ver=6.0.5',
			ABSPATH . '/wp-content/plugins/wp-schema-pro/admin/assets/css/frontend.css?ver=1.3.0',
			ABSPATH . '/wp-content/plugins/js_composer/assets/lib/bower/animate-css/animate.min.css?ver=6.0.5',
			ABSPATH . '/wp-content/plugins/js_composer/assets/css/js_composer_tta.min.css?ver=6.0.5',
			ABSPATH . '/wp-content/themes/consulting/assets/css/slick.css?ver=4.6.8.1',
			ABSPATH . '/wp-content/plugins/js_composer/assets/lib/prettyphoto/css/prettyPhoto.min.css?ver=6.0.5',
			ABSPATH . '/wp-content/plugins/js_composer/assets/lib/owl-carousel2-dist/assets/owl.min.css?ver=6.0.5',	
			ABSPATH . '/wp-includes/css/dist/block-library/style.min.css?ver=5.3.2',
			
			//'https://forms.toomarketer.com/Content/pikaday.css',
			//'https://popupmaker.com/public/assets/lib/SGPMPopup.css'
		),

		'excludes' => array(
			'keywords' => array(
				'code.jquery.com',
				'wp-content',
				'wp-includes'
			)
		)

	);

    class GRUNTS_TASKS {

    	protected $grunts;

    	public function __construct() {    	

    		global $grunts;

    		$this->grunts = $grunts;

    		$this->perform();

    	}

    	private function removeWhiteSpace($str)
    	{
    		$str = str_replace("\t", ' ', $str);
    		$str = str_replace("\n",  '', $str);
    		$str = str_replace("\r",  '', $str);
    		
    		while (stristr($str, '  '))
    		{
    			$str = str_replace('  ', ' ', $str);
    		}
    		
    		return $str;
    	}

    	protected function get() {

			$data = array();

			$data['css'] = '';
			$data['js'] = '';

			$grunts = $this->grunts;

			foreach( $grunts['css'] as $fn ) :

				$pos = strpos( $fn, '?ver' );

				if ( false !== $pos ) :

					$fn = substr($fn, 0, $pos);

				endif;

				/*if ( file_exists( $fn ) ) :

					//file_put_contents('grunts.log', $fn . ' OK ...', FILE_APPEND | LOCK_EX );			

					echo '<p>' . $fn . ' OK ... </p>';

				else :

					//file_put_contents('grunts.log', $fn . ' not exist ...', FILE_APPEND | LOCK_EX );	

					echo '<p>' . $fn . ' not exist ... </p>';					

				endif;*/

				$data['css'] .= file_get_contents( $fn );

			endforeach;

			foreach( $grunts['js'] as $fn ) :

				$pos = strpos( $fn, '?ver' );

				if ( false !== $pos ) :

					$fn = substr($fn, 0, $pos);

				endif;

				$contents = file_get_contents( $fn );

				if ( ';' !== substr( $contents, strlen( $contents ) - 1, 1 ) ) :

					$contents .= ';';

				endif;

				$data['js'] .= $contents . PHP_EOL;

			endforeach;
			
			return $data;

		}

		protected function perform() {

			$data = $this->get();

			if ( ! file_exists( GRUNTS_CACHE_DIRECTORY ) ) :

				mkdir( GRUNTS_CACHE_DIRECTORY, 0777, true );

			endif;

			$data['css'] = preg_replace( sprintf( '/%s|%s|%s/i', 
                                                 '..\/fonts\/',
                                                 '\/fonts\/',
                                                 'fonts\/' ), GRUNTS_THEME_FONT_DIRECTORY_URI . '/', $data['css'] );

    		$data['css'] = preg_replace( sprintf( '/%s|%s|%s|%s|%s|%s|%s/i', 
                                                 '..\/images\/',
                                                 '\/images\/',
                                                 'images\/',
                                                 '..\/..\/images\/',                               
                                                 '..\/img\/',
                                                 '\/img\/',
                                                 'img\/' ), GRUNTS_THEME_IMAGES_DIRECTORY_URI . '/', $data['css'] );

    		$data['css'] = str_replace("url('../assets/", "url('" . GRUNTS_THEME_IMAGES_DIRECTORY_URI . "/assets/", $data['css']);

    		$data['css'] = str_replace("url('stm.", "url('" . GRUNTS_THEME_FONT_DIRECTORY_URI . "/stm.", $data['css']);

    		$continue = true;

    		$start = 0;

    		$length = strlen( $data['css'] );

    		while ( $continue ) :	    		

	    		if ( $start < $length ) :

	    			$key = '@font-face';

	    			$pos = strpos( $data['css'], $key, $start );

		    		// found $key
		    		if ( false !== $pos ) :

		    			$pos1 = strpos( $data['css'], '}', $pos + strlen( $key ) );
		    			$substr = substr( $data['css'], $pos, $pos1 + 1 );

		    			// not found attribute
		    			if ( false === strpos( $substr, 'font-display:' ) ):	

		    				$_pos = strpos( $data['css'], '{', $pos );	    				

		    				$data['css'] = substr_replace($data['css'], 'font-display: swap;', $_pos + 1, 0);
		    			
		    			endif;

		    			$start = $pos1 + 1;

		    			continue;	

		    		else :

		    			$continue = false;

		    		endif;		    		

		    	else :

		    		$continue = false;

		    	endif;	    		

	    	endwhile;

			//$data['css'] = $this->removeWhiteSpace( $data['css'] );

			file_put_contents(STYLESHEET_COMBINE_FILE_PATH, $data['css']);
			file_put_contents(JAVASCRIPT_COMBINE_FILE_PATH, $data['js']);

		}

    } ?>